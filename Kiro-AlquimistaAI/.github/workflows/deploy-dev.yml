name: Deploy to Development

on:
  push:
    branches:
      - develop

env:
  AWS_REGION: us-east-1
  NODE_VERSION: 20.x

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm run test
        env:
          CI: true
      
      - name: Build project
        run: npm run build
      
      - name: Run security scan
        run: npm run security:full
        continue-on-error: false

  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: development
      url: https://dev.alquimista.ai
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: CDK Diff
        run: npm run diff -- --context env=dev
        continue-on-error: true
      
      - name: CDK Deploy
        run: npm run deploy:dev -- --require-approval never
        timeout-minutes: 30
      
      - name: Get CloudFormation outputs
        id: outputs
        run: |
          API_URL=$(aws cloudformation describe-stacks --stack-name FibonacciStack-dev --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against dev environment..."
          API_URL="${{ steps.outputs.outputs.api_url }}"
          
          # Test health endpoint
          echo "Testing /health endpoint..."
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health")
          
          if [ "$HEALTH_RESPONSE" != "200" ]; then
            echo "❌ Health check failed with status: $HEALTH_RESPONSE"
            exit 1
          fi
          
          echo "✅ Health check passed"
          
          # Test health endpoint response body
          HEALTH_BODY=$(curl -s "${API_URL}/health")
          echo "Health response: $HEALTH_BODY"
          
          if echo "$HEALTH_BODY" | grep -q '"ok":true'; then
            echo "✅ Health endpoint returns correct payload"
          else
            echo "❌ Health endpoint payload incorrect"
            exit 1
          fi
          
          echo "✅ All smoke tests passed"
      
      - name: Notify deployment status
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: ${{ job.status }}
          environment: 'development'
          branch: ${{ github.ref_name }}
          commit: ${{ github.sha }}
          actor: ${{ github.actor }}
          api-url: ${{ steps.outputs.outputs.api_url }}
          job-name: 'Deploy to Dev'
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
      - name: Create GitHub comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const message = `${emoji} Development deployment ${status}
            
            **Environment:** Development
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Actor:** ${{ github.actor }}
            **API URL:** ${{ steps.outputs.outputs.api_url }}
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });
