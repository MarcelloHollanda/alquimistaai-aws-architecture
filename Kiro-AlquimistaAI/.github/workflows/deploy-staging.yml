name: Deploy to Staging

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  NODE_VERSION: 20.x

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run tests
        run: npm run test
        env:
          CI: true
      
      - name: Build project
        run: npm run build
      
      - name: Run security scan
        run: npm run security:full
        continue-on-error: false

  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: staging
      url: https://staging.alquimista.ai
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: CDK Diff
        run: npm run diff -- --context env=staging
        continue-on-error: true
      
      - name: CDK Deploy
        run: npm run deploy:staging -- --require-approval never
        timeout-minutes: 30
      
      - name: Get CloudFormation outputs
        id: outputs
        run: |
          API_URL=$(aws cloudformation describe-stacks --stack-name FibonacciStack-staging --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' --output text)
          CLOUDFRONT_URL=$(aws cloudformation describe-stacks --stack-name FibonacciStack-staging --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"
          echo "CloudFront URL: $CLOUDFRONT_URL"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging environment..."
          API_URL="${{ steps.outputs.outputs.api_url }}"
          
          # Test health endpoint
          echo "Testing /health endpoint..."
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health")
          
          if [ "$HEALTH_RESPONSE" != "200" ]; then
            echo "‚ùå Health check failed with status: $HEALTH_RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Health check passed"
          
          # Test health endpoint response body
          HEALTH_BODY=$(curl -s "${API_URL}/health")
          echo "Health response: $HEALTH_BODY"
          
          if echo "$HEALTH_BODY" | grep -q '"ok":true'; then
            echo "‚úÖ Health endpoint returns correct payload"
          else
            echo "‚ùå Health endpoint payload incorrect"
            exit 1
          fi
          
          # Test events endpoint (should require auth or return proper error)
          echo "Testing /events endpoint..."
          EVENTS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${API_URL}/events" -H "Content-Type: application/json" -d '{}')
          echo "Events endpoint status: $EVENTS_RESPONSE"
          
          # Verify CloudWatch alarms are configured
          echo "Checking CloudWatch alarms..."
          ALARM_COUNT=$(aws cloudwatch describe-alarms --alarm-name-prefix fibonacci-staging --query 'length(MetricAlarms)' --output text)
          echo "Found $ALARM_COUNT alarms configured"
          
          if [ "$ALARM_COUNT" -gt 0 ]; then
            echo "‚úÖ CloudWatch alarms are configured"
          else
            echo "‚ö†Ô∏è  No CloudWatch alarms found"
          fi
          
          echo "‚úÖ All smoke tests passed"
      
      - name: Create deployment summary
        run: |
          echo "## üöÄ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** ${{ steps.outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront:** ${{ steps.outputs.outputs.cloudfront_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Health check: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- API endpoints: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch alarms: Configured" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify deployment status
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: ${{ job.status }}
          environment: 'staging'
          branch: ${{ github.ref_name }}
          commit: ${{ github.sha }}
          actor: ${{ github.actor }}
          api-url: ${{ steps.outputs.outputs.api_url }}
          cloudfront-url: ${{ steps.outputs.outputs.cloudfront_url }}
          job-name: 'Deploy to Staging'
          run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
      - name: Create GitHub comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = `${emoji} Staging deployment ${status}
            
            **Environment:** Staging
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Actor:** ${{ github.actor }}
            **API URL:** ${{ steps.outputs.outputs.api_url }}
            **CloudFront URL:** ${{ steps.outputs.outputs.cloudfront_url }}
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });
