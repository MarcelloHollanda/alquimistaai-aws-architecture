name: Kiro AI Assistant

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Tipo de assistÃªncia'
        required: true
        type: choice
        options:
          - 'code-review'
          - 'documentation'
          - 'bug-analysis'
          - 'performance-check'

jobs:
  kiro-assistant:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Kiro Code Analysis
        id: analysis
        run: |
          echo "ğŸ¤– Kiro AI Assistant - AnÃ¡lise AutomÃ¡tica" >> analysis.md
          echo "" >> analysis.md
          
          # AnÃ¡lise de cÃ³digo
          echo "## ğŸ“Š AnÃ¡lise de CÃ³digo" >> analysis.md
          echo "- **Arquivos TypeScript**: $(find . -name '*.ts' | wc -l)" >> analysis.md
          echo "- **Arquivos de Teste**: $(find . -name '*.test.ts' | wc -l)" >> analysis.md
          echo "- **Workflows GitHub**: $(find .github/workflows -name '*.yml' | wc -l)" >> analysis.md
          echo "" >> analysis.md
          
          # VerificaÃ§Ã£o de seguranÃ§a
          echo "## ğŸ” VerificaÃ§Ã£o de SeguranÃ§a" >> analysis.md
          if npm audit --audit-level=high --json > audit.json 2>/dev/null; then
            VULNERABILITIES=$(cat audit.json | jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical')
            echo "- **Vulnerabilidades crÃ­ticas/altas**: $VULNERABILITIES" >> analysis.md
          else
            echo "- **Status**: âœ… Nenhuma vulnerabilidade crÃ­tica encontrada" >> analysis.md
          fi
          echo "" >> analysis.md
          
          # VerificaÃ§Ã£o de testes
          echo "## ğŸ§ª Cobertura de Testes" >> analysis.md
          if npm run test:coverage > /dev/null 2>&1; then
            echo "- **Status**: âœ… Testes executados com sucesso" >> analysis.md
          else
            echo "- **Status**: âš ï¸ Verificar configuraÃ§Ã£o de testes" >> analysis.md
          fi
          echo "" >> analysis.md
          
          # RecomendaÃ§Ãµes do Kiro
          echo "## ğŸ’¡ RecomendaÃ§Ãµes do Kiro AI" >> analysis.md
          echo "- Manter dependÃªncias atualizadas" >> analysis.md
          echo "- Executar testes antes de cada deploy" >> analysis.md
          echo "- Verificar logs do CloudWatch regularmente" >> analysis.md
          echo "- Monitorar custos AWS mensalmente" >> analysis.md
          echo "" >> analysis.md
          
          echo "## ğŸ”— Links Ãšteis" >> analysis.md
          echo "- [DocumentaÃ§Ã£o do Projeto](./README.md)" >> analysis.md
          echo "- [Guia de Deploy](./Docs/Deploy/)" >> analysis.md
          echo "- [ConfiguraÃ§Ã£o de Secrets](./Docs/Deploy/GITHUB-SECRETS-CONFIGURATION.md)" >> analysis.md
          
          # Salvar anÃ¡lise
          cat analysis.md
      
      - name: Comment on Issue/PR
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.md', 'utf8');
            
            const comment = `## ğŸ¤– Kiro AI Assistant
            
            OlÃ¡! Sou o assistente Kiro AI e analisei automaticamente este ${context.eventName === 'issues' ? 'issue' : 'pull request'}.
            
            ${analysis}
            
            ---
            *Esta anÃ¡lise foi gerada automaticamente. Para assistÃªncia mais detalhada, consulte a documentaÃ§Ã£o do projeto.*`;
            
            if (context.eventName === 'issues') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              github.rest.pulls.createReview({
                pull_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment,
                event: 'COMMENT'
              });
            }
      
      - name: Update Project Status
        run: |
          echo "ğŸ“Š Status do Projeto AlquimistaAI" > status.md
          echo "- **Ãšltima anÃ¡lise**: $(date)" >> status.md
          echo "- **Branch**: ${{ github.ref_name }}" >> status.md
          echo "- **Commit**: ${{ github.sha }}" >> status.md
          echo "- **Kiro AI**: âœ… Monitoramento ativo" >> status.md