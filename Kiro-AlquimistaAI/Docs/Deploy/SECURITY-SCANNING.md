# Security Scanning Implementation

## Overview

This document describes the security vulnerability scanning implementation for the Fibonacci AWS Setup project. The security scanning system automatically detects and reports vulnerabilities in project dependencies, blocking deployments when critical issues are found.

## Components

### 1. npm audit Integration

**Purpose:** Scan npm dependencies for known security vulnerabilities

**Configuration:**
- Runs automatically in CI/CD pipeline
- Blocks deployment on critical vulnerabilities
- Generates detailed reports

**Scripts:**
```bash
# Run audit with moderate threshold
npm run audit

# Fix vulnerabilities automatically
npm run audit:fix

# Check only critical vulnerabilities
npm run audit:critical

# Run full security scan (audit + lint)
npm run security:scan

# Run security check with deployment blocking
npm run security:check
```

### 2. Security Check Script

**Location:** `scripts/security-check.js`

**Features:**
- Executes npm audit and analyzes results
- Categorizes vulnerabilities by severity
- Displays detailed vulnerability information
- Generates markdown reports
- Blocks deployment on critical vulnerabilities
- Provides actionable remediation steps

**Exit Codes:**
- `0` - No critical vulnerabilities (deployment allowed)
- `1` - Critical vulnerabilities found (deployment blocked)

**Usage:**
```bash
node scripts/security-check.js
# or
npm run security:check
```

### 3. GitHub Actions Workflow

**Location:** `.github/workflows/security-scan.yml`

**Triggers:**
- Push to `main` or `develop` branches
- Pull requests to `main` or `develop`
- Daily scheduled scan at 2 AM UTC
- Manual workflow dispatch

**Jobs:**

#### security-scan
- Checks out code
- Installs dependencies
- Runs npm audit
- Executes security check script
- Uploads audit reports as artifacts
- Comments on PRs with security status
- Fails workflow if critical vulnerabilities found

#### dependency-review
- Reviews dependency changes in PRs
- Checks for vulnerabilities in new dependencies
- Blocks PRs with critical vulnerabilities
- Checks license compliance
- Posts summary in PR comments

### 4. Dependabot Configuration

**Location:** `.github/dependabot.yml`

**Features:**
- Automatic dependency updates
- Weekly schedule (Mondays at 9 AM BRT)
- Grouped updates by category:
  - AWS SDK packages
  - AWS Lambda Powertools
  - Development dependencies
  - TypeScript and type definitions
- Automatic PR creation
- Security labels and reviewers
- Conventional commit messages

**Update Groups:**
- `aws-sdk` - All AWS SDK packages
- `powertools` - AWS Lambda Powertools
- `dev-dependencies` - Development tools
- `typescript` - TypeScript and type definitions

## Vulnerability Severity Levels

### Critical üî¥
- **Action:** Immediate fix required
- **Impact:** Deployment blocked
- **Timeline:** Must be resolved before merge/deploy

### High üü†
- **Action:** Fix as soon as possible
- **Impact:** Warning issued, deployment allowed
- **Timeline:** Should be resolved within 1 week

### Moderate üü°
- **Action:** Plan fix in next sprint
- **Impact:** No deployment impact
- **Timeline:** Address in regular maintenance

### Low üîµ
- **Action:** Fix in regular maintenance
- **Impact:** No deployment impact
- **Timeline:** Address when convenient

### Info ‚ÑπÔ∏è
- **Action:** Review and document
- **Impact:** No deployment impact
- **Timeline:** No urgency

## Workflow Integration

### Pre-Deployment Checks

Before any deployment, the security scan must pass:

```bash
# 1. Run security check
npm run security:check

# 2. If critical vulnerabilities found, fix them
npm audit fix

# 3. If automatic fix fails, manually update packages
npm update <package-name>

# 4. Re-run security check
npm run security:check

# 5. Proceed with deployment only if check passes
npm run deploy:prod
```

### CI/CD Pipeline Integration

The security scan is integrated into the deployment pipeline:

```yaml
# Example: .github/workflows/deploy-prod.yml
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm ci
      - run: npm run security:check  # Blocks if critical vulns found
  
  deploy:
    needs: security-scan  # Only runs if security scan passes
    runs-on: ubuntu-latest
    steps:
      - run: npm run deploy:prod
```

## Reports and Artifacts

### Security Scan Report

**Location:** `Docs/Deploy/SECURITY-SCAN-REPORT.md`

**Contents:**
- Timestamp of scan
- Vulnerability summary by severity
- Deployment status (allowed/blocked)
- Detailed recommendations
- Next steps and resources

**Generated by:** `scripts/security-check.js`

### Audit Report JSON

**Location:** `audit-report.json` (CI/CD artifact)

**Contents:**
- Raw npm audit output in JSON format
- Detailed vulnerability information
- Dependency tree
- Fix recommendations

**Retention:** 30 days in GitHub Actions artifacts

## Remediation Procedures

### Automatic Fixes

Most vulnerabilities can be fixed automatically:

```bash
# Fix all vulnerabilities (safe updates)
npm audit fix

# Fix including breaking changes (use with caution)
npm audit fix --force

# Verify fixes
npm run security:check
```

### Manual Fixes

For vulnerabilities without automatic fixes:

1. **Identify the vulnerable package:**
   ```bash
   npm audit
   ```

2. **Check for updates:**
   ```bash
   npm outdated <package-name>
   ```

3. **Update the package:**
   ```bash
   npm update <package-name>
   # or for major version updates
   npm install <package-name>@latest
   ```

4. **Test the application:**
   ```bash
   npm run build
   npm run test
   npm run lint
   ```

5. **Verify the fix:**
   ```bash
   npm run security:check
   ```

### No Fix Available

If no fix is available:

1. **Assess the risk:**
   - Is the vulnerable code path used in your application?
   - What is the potential impact?
   - Are there workarounds?

2. **Document the decision:**
   - Create an issue tracking the vulnerability
   - Document why it's acceptable (if it is)
   - Set a reminder to check for updates

3. **Consider alternatives:**
   - Can you use a different package?
   - Can you implement the functionality yourself?
   - Can you isolate the vulnerable code?

4. **Monitor for updates:**
   - Dependabot will notify you when a fix is available
   - Check manually periodically

## Best Practices

### Development

1. **Run security checks before committing:**
   ```bash
   npm run security:check
   ```

2. **Keep dependencies up to date:**
   ```bash
   npm outdated
   npm update
   ```

3. **Review Dependabot PRs promptly:**
   - Check for breaking changes
   - Review changelogs
   - Test thoroughly

4. **Use exact versions for critical packages:**
   ```json
   {
     "dependencies": {
       "aws-cdk-lib": "2.152.0"  // No ^ or ~
     }
   }
   ```

### CI/CD

1. **Always run security scan before deployment**
2. **Block deployments on critical vulnerabilities**
3. **Archive security reports for compliance**
4. **Set up alerts for security scan failures**

### Monitoring

1. **Review security scan reports weekly**
2. **Track vulnerability trends over time**
3. **Monitor Dependabot PRs and merge promptly**
4. **Schedule regular dependency audits**

## Compliance and Auditing

### LGPD Compliance

Security scanning helps maintain LGPD compliance by:
- Preventing data breaches through vulnerable dependencies
- Maintaining audit trail of security checks
- Ensuring timely updates to security patches

### Audit Trail

All security scans are logged and archived:
- GitHub Actions workflow runs (90 days retention)
- Security scan reports (30 days retention)
- Dependabot PR history (permanent)

### Reporting

Generate compliance reports:

```bash
# Run security scan and generate report
npm run security:check

# View report
cat Docs/Deploy/SECURITY-SCAN-REPORT.md

# Export audit data
npm audit --json > security-audit-$(date +%Y%m%d).json
```

## Troubleshooting

### Security Check Fails in CI/CD

**Problem:** Security check passes locally but fails in CI/CD

**Solution:**
1. Ensure `package-lock.json` is committed
2. Use `npm ci` instead of `npm install` in CI/CD
3. Check for environment-specific dependencies

### False Positives

**Problem:** Vulnerability reported but not applicable

**Solution:**
1. Verify the vulnerability affects your code path
2. Document the false positive
3. Consider using `npm audit --production` to exclude dev dependencies
4. Use `.npmrc` to configure audit level

### Dependabot PRs Not Merging

**Problem:** Dependabot PRs are created but not merged

**Solution:**
1. Review and approve PRs promptly
2. Set up auto-merge for minor/patch updates
3. Configure branch protection rules appropriately
4. Ensure CI/CD passes before merge

## Resources

### Documentation
- [npm audit](https://docs.npmjs.com/cli/v8/commands/npm-audit)
- [GitHub Dependabot](https://docs.github.com/en/code-security/dependabot)
- [GitHub Actions Security](https://docs.github.com/en/actions/security-guides)
- [OWASP Dependency Check](https://owasp.org/www-project-dependency-check/)

### Tools
- [Snyk](https://snyk.io/) - Advanced vulnerability scanning
- [npm-check-updates](https://www.npmjs.com/package/npm-check-updates) - Update dependencies
- [audit-ci](https://www.npmjs.com/package/audit-ci) - CI/CD integration

### Security Advisories
- [GitHub Advisory Database](https://github.com/advisories)
- [npm Security Advisories](https://www.npmjs.com/advisories)
- [CVE Database](https://cve.mitre.org/)

## Support

For security-related questions or concerns:
1. Review this documentation
2. Check existing GitHub issues
3. Contact the security team
4. Create a security advisory (for sensitive issues)

---

**Last Updated:** 2024
**Maintained by:** Alquimista.AI Security Team
**Related Requirements:** 17.10
